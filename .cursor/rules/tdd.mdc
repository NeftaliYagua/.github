---
alwaysApply: true
---
# ‚ö†Ô∏è TEST-DRIVEN DEVELOPMENT (TDD) - OBLIGATORIO ‚ö†Ô∏è

**ESTAS REGLAS SON LA LEY. DEBEN SEGUIRSE ESTRICTAMENTE EN TODO EL DESARROLLO.**

## Principio Fundamental

**TDD es el garante de calidad. Las pruebas NO son opcionales, son el requisito previo para cualquier c√≥digo de producci√≥n.**

## ‚ö†Ô∏è CRITICAL: TDD Estricto - Red-Green-Refactor

**IMPORTANT: NUNCA ESCRIBIR C√ìDIGO SIN PRUEBA QUE FALLE PRIMERO**

### Ciclo TDD Obligatorio

1. **RED üî¥ - Escribir Prueba que Falle**
   - ‚úÖ **SIEMPRE** escribir la prueba ANTES del c√≥digo
   - ‚úÖ **SIEMPRE** verificar que la prueba falla por la raz√≥n correcta
   - ‚úÖ **SIEMPRE** documentar qu√© debe fallar y por qu√©
   - ‚ùå **NUNCA** escribir c√≥digo sin prueba previa

2. **GREEN üü¢ - Hacer que la Prueba Pase**
   - ‚úÖ **SIEMPRE** escribir el c√≥digo M√çNIMO necesario para que pase
   - ‚úÖ **SIEMPRE** ejecutar pruebas despu√©s de cada cambio
   - ‚úÖ **SIEMPRE** verificar que no se rompieron pruebas anteriores
   - ‚ùå **NUNCA** escribir m√°s c√≥digo del necesario

3. **REFACTOR üîµ - Mejorar C√≥digo**
   - ‚úÖ **SIEMPRE** mejorar c√≥digo manteniendo pruebas en verde
   - ‚úÖ **SIEMPRE** eliminar duplicaci√≥n
   - ‚úÖ **SIEMPRE** mejorar legibilidad y mantenibilidad
   - ‚úÖ **SIEMPRE** verificar que todas las pruebas siguen pasando
   - ‚ùå **NUNCA** refactorizar sin pruebas que garanticen el comportamiento

## ‚ö†Ô∏è CRITICAL: Coherencia de Pruebas con Requerimientos

**IMPORTANT: LAS PRUEBAS DEBEN ESTAR CONSTRUIDAS CONFORME AL REQUERIMIENTO FUNCIONAL, EL PLAN Y EL DISE√ëO DEL PROYECTO**

### Antes de Escribir C√≥digo

1. ‚úÖ **SIEMPRE** revisar requerimientos funcionales
2. ‚úÖ **SIEMPRE** revisar el plan del proyecto
3. ‚úÖ **SIEMPRE** revisar el dise√±o del proyecto
4. ‚úÖ **SIEMPRE** dise√±ar pruebas completas ANTES de implementar
5. ‚úÖ **SIEMPRE** verificar que las pruebas cubren todos los casos de uso
6. ‚ùå **NUNCA** escribir c√≥digo sin tener estructura de coherencia en las pruebas

### Estructura de Pruebas

Las pruebas deben cubrir:

1. **Pruebas Unitarias** - L√≥gica de negocio, modelos, enums, servicios
2. **Pruebas Funcionales** - Endpoints, rutas, permisos, CRUD completo
3. **Pruebas Visuales (Dusk)** - UI completa, interacciones, regresi√≥n visual

### Cobertura de Pruebas

- ‚úÖ **SIEMPRE** tener pruebas para cada funcionalidad descrita en requerimientos
- ‚úÖ **SIEMPRE** verificar permisos y autorizaci√≥n
- ‚úÖ **SIEMPRE** probar casos de √©xito y casos de error
- ‚úÖ **SIEMPRE** probar validaciones
- ‚úÖ **SIEMPRE** probar edge cases
- ‚ùå **NUNCA** dar por terminado sin verificar cobertura completa

## ‚ö†Ô∏è CRITICAL: Pruebas como Documentaci√≥n Viva

**IMPORTANT: LAS PRUEBAS SON LA DOCUMENTACI√ìN DEL COMPORTAMIENTO ESPERADO**

### Nombres de Pruebas

- ‚úÖ **SIEMPRE** usar nombres descriptivos que expliquen qu√© se prueba
- ‚úÖ **SIEMPRE** usar formato `test_what_should_happen_when_condition()`
- ‚ùå **NUNCA** usar nombres gen√©ricos como `test1()`, `test_user()`

Ejemplos:
```php
// ‚úÖ GOOD
public function test_admin_can_create_user(): void
public function test_operator_cannot_access_users_create(): void
public function test_validation_requires_unique_email(): void

// ‚ùå BAD
public function test_create(): void
public function test_user(): void
```

### Organizaci√≥n de Pruebas

- ‚úÖ **SIEMPRE** agrupar pruebas relacionadas en la misma clase
- ‚úÖ **SIEMPRE** usar `setUp()` para datos comunes
- ‚úÖ **SIEMPRE** usar `StagingSeeder` o datos consistentes para pruebas funcionales
- ‚úÖ **SIEMPRE** limpiar datos entre pruebas (`RefreshDatabase`)

## ‚ö†Ô∏è CRITICAL: Verificaci√≥n Antes de Declarar Completado

**IMPORTANT: NO DECLARAR COMPLETADO SIN VERIFICAR QUE LAS PRUEBAS EST√ÅN CORRECTAS Y PASAN**

### Proceso Obligatorio

1. ‚úÖ **SIEMPRE** ejecutar todas las pruebas relacionadas
2. ‚úÖ **SIEMPRE** verificar que las pruebas pasan
3. ‚úÖ **SIEMPRE** verificar que las pruebas est√°n bien escritas
4. ‚úÖ **SIEMPRE** verificar que las pruebas cubren el requerimiento funcional
5. ‚úÖ **SIEMPRE** verificar que no hay pruebas duplicadas o innecesarias
6. ‚ùå **NUNCA** declarar completado sin ejecutar pruebas
7. ‚ùå **NUNCA** declarar completado si las pruebas fallan
8. ‚ùå **NUNCA** declarar completado si las pruebas no est√°n correctas

### Pregunta Obligatoria

**Antes de declarar cualquier tarea como completada, preguntarse:**
- ¬øLas pruebas est√°n construidas conforme al requerimiento funcional?
- ¬øLas pruebas est√°n construidas conforme al plan?
- ¬øLas pruebas est√°n construidas conforme al dise√±o?
- ¬øC√≥mo s√© si las pruebas pasan o no si no tengo una estructura de coherencia?

## Entorno de Pruebas

### Configuraci√≥n

- ‚úÖ **SIEMPRE** usar `phpunit.xml` para configuraci√≥n de entorno de pruebas
- ‚úÖ **SIEMPRE** configurar timezone fijo para pruebas (`APP_TIMEZONE` en `phpunit.xml`)
- ‚úÖ **SIEMPRE** usar base de datos separada para pruebas (SQLite en memoria recomendado)
- ‚úÖ **SIEMPRE** usar `StagingSeeder` para datos consistentes en pruebas funcionales
- ‚úÖ **SIEMPRE** marcar sistema como instalado (`markSystemAsInstalled()`) cuando sea necesario

### Datos de Prueba

- ‚úÖ **SIEMPRE** usar `StagingSeeder` para precargar datos realistas
- ‚úÖ **SIEMPRE** obtener usuarios de prueba por email espec√≠fico del seeder
- ‚úÖ **SIEMPRE** usar factories solo cuando sea necesario crear datos espec√≠ficos
- ‚ùå **NUNCA** crear usuarios gen√©ricos en cada prueba si ya existen en el seeder

## Tipos de Pruebas

### Pruebas Unitarias

**Prop√≥sito:** Verificar l√≥gica de negocio aislada

```php
// ‚úÖ GOOD: Prueba unitaria clara y enfocada
public function test_user_can_parameterize_when_admin(): void
{
    $admin = User::factory()->admin()->create();
    $this->assertTrue($admin->canParameterize());
}
```

**Ubicaci√≥n:** `tests/Unit/`

### Pruebas Funcionales

**Prop√≥sito:** Verificar funcionalidad completa (HTTP, permisos, CRUD)

```php
// ‚úÖ GOOD: Prueba funcional con datos del seeder
public function test_admin_can_create_user(): void
{
    $admin = User::where('email', 'admin@cortex-ia.com.co')->firstOrFail();
    
    $response = $this->actingAs($admin)->post('/operator/users', [
        'name' => 'Nuevo Usuario',
        'email' => 'nuevo@example.com',
        'password' => 'password123',
        'role' => UserRole::CLIENT->value,
    ]);
    
    $response->assertStatus(302);
    $this->assertDatabaseHas('users', ['email' => 'nuevo@example.com']);
}
```

**Ubicaci√≥n:** `tests/Feature/`

### Pruebas Visuales (Dusk)

**Prop√≥sito:** Verificar UI completa y regresi√≥n visual

```php
// ‚úÖ GOOD: Prueba visual con screenshot
public function test_users_list_page_visual(): void
{
    $this->browse(function (Browser $browser) {
        $operator = User::where('email', 'operador@cortex-ia.com.co')->firstOrFail();
        
        $browser->loginAs($operator)
            ->visit('/operator/users')
            ->waitFor('.fi-main-content', 10)
            ->pause(1000)
            ->assertScreenshot('users-list-page');
    });
}
```

**Ubicaci√≥n:** `tests/Browser/`

## Filament 5.x Testing

### Testing Resources

- ‚úÖ **SIEMPRE** probar acceso a recursos basado en permisos
- ‚úÖ **SIEMPRE** probar acciones (Create, Edit, Delete, View) con control de visibilidad
- ‚úÖ **SIEMPRE** probar tabs y filtros
- ‚úÖ **SIEMPRE** probar b√∫squeda y ordenamiento

### Testing Tables

- ‚úÖ **SIEMPRE** probar columnas visibles
- ‚úÖ **SIEMPRE** probar acciones de tabla con permisos
- ‚úÖ **SIEMPRE** probar filtros y b√∫squeda
- ‚úÖ **SIEMPRE** probar ordenamiento

### Testing Schemas/Forms

- ‚úÖ **SIEMPRE** probar validaciones
- ‚úÖ **SIEMPRE** probar campos condicionales (password opcional en edit)
- ‚úÖ **SIEMPRE** probar componentes espec√≠ficos (ToggleButtons, Toggle, etc.)

## Laravel 12 Testing

### HTTP Tests

- ‚úÖ **SIEMPRE** usar `actingAs()` para autenticaci√≥n
- ‚úÖ **SIEMPRE** verificar c√≥digos de estado correctos (200, 403, 422, etc.)
- ‚úÖ **SIEMPRE** verificar respuestas JSON cuando corresponda
- ‚úÖ **SIEMPRE** verificar base de datos con `assertDatabaseHas()` / `assertDatabaseMissing()`

### Database Tests

- ‚úÖ **SIEMPRE** usar `RefreshDatabase` trait
- ‚úÖ **SIEMPRE** limpiar datos entre pruebas
- ‚úÖ **SIEMPRE** usar transacciones cuando sea necesario

### Browser Tests (Dusk)

- ‚úÖ **SIEMPRE** usar `DatabaseMigrations` para Dusk
- ‚úÖ **SIEMPRE** marcar sistema como instalado en `setUp()`
- ‚úÖ **SIEMPRE** usar `waitFor()` en lugar de `pause()` cuando sea posible
- ‚úÖ **SIEMPRE** capturar screenshots para regresi√≥n visual

## Errores Comunes a Evitar

### ‚ùå BAD: Escribir c√≥digo sin prueba

```php
// ‚ùå BAD: C√≥digo sin prueba previa
public function canAccessPanel(Panel $panel): bool
{
    return $this->isAdmin();
}
```

### ‚úÖ GOOD: Prueba primero, c√≥digo despu√©s

```php
// ‚úÖ GOOD: Prueba primero
public function test_user_can_access_operator_panel_when_admin(): void
{
    $admin = User::factory()->admin()->create();
    $panel = \Filament\Facades\Filament::getPanel('operator');
    $this->assertTrue($admin->canAccessPanel($panel));
}

// Luego implementar c√≥digo m√≠nimo
public function canAccessPanel(Panel $panel): bool
{
    return $this->isAdmin();
}
```

### ‚ùå BAD: Pruebas sin coherencia con requerimientos

```php
// ‚ùå BAD: Prueba gen√©rica sin relaci√≥n con requerimiento
public function test_user(): void
{
    $user = User::factory()->create();
    $this->assertNotNull($user);
}
```

### ‚úÖ GOOD: Prueba espec√≠fica seg√∫n requerimiento

```php
// ‚úÖ GOOD: Prueba espec√≠fica del requerimiento funcional
public function test_tabs_show_correct_badges(): void
{
    $operator = User::where('email', 'operador@cortex-ia.com.co')->firstOrFail();
    $allCount = User::count();
    $staffCount = User::where('role', UserRole::STAFF)->count();
    
    $response = $this->actingAs($operator)->get('/operator/users');
    
    $response->assertStatus(200);
    $response->assertSee((string) $allCount, false);
    $response->assertSee((string) $staffCount, false);
}
```

## Checklist de TDD

### Antes de Escribir C√≥digo

- [ ] ¬øRevis√© los requerimientos funcionales?
- [ ] ¬øRevis√© el plan del proyecto?
- [ ] ¬øRevis√© el dise√±o del proyecto?
- [ ] ¬øDise√±√© todas las pruebas necesarias?
- [ ] ¬øLas pruebas cubren todos los casos de uso?
- [ ] ¬øLas pruebas est√°n bien estructuradas?

### Durante Desarrollo (RED)

- [ ] ¬øEscrib√≠ la prueba primero?
- [ ] ¬øLa prueba falla por la raz√≥n correcta?
- [ ] ¬øDocument√© qu√© debe fallar y por qu√©?

### Durante Implementaci√≥n (GREEN)

- [ ] ¬øEscrib√≠ c√≥digo m√≠nimo para que pase?
- [ ] ¬øEjecut√© pruebas despu√©s de cada cambio?
- [ ] ¬øVerifiqu√© que no se rompieron pruebas anteriores?

### Despu√©s de Implementaci√≥n (REFACTOR)

- [ ] ¬øMejor√© el c√≥digo manteniendo pruebas en verde?
- [ ] ¬øElimin√© duplicaci√≥n?
- [ ] ¬øMejor√© legibilidad?
- [ ] ¬øTodas las pruebas siguen pasando?

### Antes de Declarar Completado

- [ ] ¬øTodas las pruebas pasan?
- [ ] ¬øLas pruebas est√°n correctas?
- [ ] ¬øLas pruebas cubren el requerimiento funcional?
- [ ] ¬øLas pruebas est√°n construidas conforme al plan?
- [ ] ¬øLas pruebas est√°n construidas conforme al dise√±o?
- [ ] ¬øTengo estructura de coherencia en las pruebas?

## Referencias

- **Laravel Testing:** https://laravel.com/docs/12.x/testing
- **Filament Testing:** https://filamentphp.com/docs/5.x/testing
- **TDD Methodology:** Red-Green-Refactor cycle
- **Test Coverage:** > 80% target

---

**RECUERDA: TDD es el garante de calidad. Las pruebas son el requisito previo, no una opci√≥n.**
